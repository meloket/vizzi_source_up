/*
jquery.timezonewidget.js - 2.1 - 11/29/2018
LGPL license
https://github.com/peterjtracey/timezoneWidget
*/
"use strict";(function(e){e.fn.timezoneWidget=function(t){var n=e.extend({},e.fn.timezoneWidget.defaults,t);"string"==typeof n.data&&(n.data=JSON.parse(n.data)),n.tz=n.data;var l={elem:null,tz:[],timers:[],regions:[],timezones:[],regSelect:null,tzSelect:null,selectedRegion:-1,selectedTimezone:"",lastSelectedTimezone:"",userSelectedTimezone:!0,translateElem:function(e){var t=e.data("tzwdate");n.debug(t),t=t&&t.length>0?moment(t+"-00:00"):moment(new Date),n.debug(t);var i=e.data("tzwformat");e.text(moment.tz(t,l.selectedTimezone).format(i));var o=e.data("tzwtrack");if(o&&parseInt(o)>0){var a=e.data("tzwtracked");if(!a){o=parseInt(o),e.data("tzwtracked",1);window.setTimeout(function(){l.timers[l.timers.length]=l.translateElem(e),window.setInterval(l.translateElem(e)},1e3*o)},1e3*(60-(new Date).getSeconds()))}}},stopTrack:function(){e.each(this.timers,function(e,t){window.clearInterval(t)})},translateTimes:function(){e("."+n.translateClass).each(function(){var t=e(this);l.translateElem(t)})},init:function(){var t=!1;if(n.loadCookie){var t=Cookies.getJSON(n.cookieName);n.debug("COOKIE"),n.debug(t)}if(t&&0==t.auto)l.selectedTimezone=t.tz,l.selectedRegion=t.region;else if(e("#"+n.tzField).length>0&&(l.selectedTimezone=e("#"+n.tzField).val(),l.selectedRegion=e("#"+n.regionField).val()),e("#"+n.regionField).length&&l.selectedRegion.length>0)l.selectedRegion=parseInt(l.selectedRegion);else if(n.guessUserTimezone){var i=new Date,o=i+"";o=o.split(/GMT/),o.length>0&&(o=o[1].split(/ /),o=o[0],5==o.length&&(o="UTC"+o.substring(0,3)+":"+o.substring(3,6)),9==o.length?e.each(n.tz,function(e,t){var n=l.findOffset(t,o);if(n)return l.userSelectedTimezone=!1,!1}):n.defaultRegion&&(l.selectedRegion=n.defaultRegion))}else n.defaultRegion&&(l.selectedRegion=n.defaultRegion);if(n.toggleElem){var a=!1;e(n.toggleElem).click(function(){a?a=!1:(n.debug("SHOWING"),l.selectedRegion>0&&(n.debug("SHOWINGselectedRegion"),l.regSelect.val(l.selectedRegion),l.regSelect.trigger("change"),l.elem.find("div.chosen-container-single").css("width","100%")),a=!0)})}},tzSelected:function(){if(n.toggleElem&&e(n.toggleElem).find(".tzw-text").text(l.tzSelect.find("option:selected").text().replace(/UTC([\+\-])0/,"$1")),n.translateClass&&l.translateTimes(),n.storeCookie){var t={region:l.selectedRegion,tz:l.selectedTimezone,auto:!l.userSelectedTimezone};Cookies.set(n.cookieName,t)}},draw:function(){l.elem.append(e("<form/>")),l.regSelect=e("<select/>").attr("size",n.tz.length).addClass("tz_region_select"),e.each(n.tz,function(t,n){l.regSelect.append(e("<option/>").val(n.id).text(n.label))}),l.elem.find("form").append(l.regSelect),l.elem.find("form").append(e("<div/>").addClass("tz_timezone_container")),l.regSelect.change(function(){l.selectedRegion=parseInt(e(this).val()),l.elem.find(".tz_timezone_container").html(""),l.tzSelect=e("<select data-placeholder='"+n.langSelectTZ+"'/>").append("<option value=''/>").addClass("tz_timezone_select"),l.getZones(function(t,n){var i=t.split(/\//);l.tzSelect.append(e("<option/>").val(t).text(n+" "+i[1].replace(/_/g," ")+(i.length>2?"/"+i[2]:"")))}),l.selectedTimezone.length>0&&l.tzSelect.val(l.selectedTimezone),l.elem.find(".tz_timezone_container").html(l.tzSelect),l.elem.find(".tz_timezone_select").chosen(),l.elem.find(".tz_timezone_select").change(function(){l.lastSelectedTimezone!=e(this).val()&&(l.lastSelectedTimezone=l.selectedTimezone=e(this).val(),e("#"+n.tzField).val(l.selectedTimezone),e("#"+n.regionField).val(l.selectedRegion),l.tzSelected(),n.onTimezoneSelect(l.selectedRegion,l.selectedTimezone,!l.userSelectedTimezone))}),l.selectedTimezone.length>0&&null!=l.tzSelect.val()?l.tzSelect.trigger("change"):n.onRegionSelect(l.selectedRegion)}),n.debug("REGION????"+l.selectedRegion),l.selectedRegion>0&&(l.regSelect.val(l.selectedRegion),l.regSelect.trigger("change")),l.tzSelect.trigger("change")},findOffset:function(t,i){n.debug("FIND OFFSET");var o=!1;return e.each(t.timezones,function(a,c){if(e.each(c.labels,function(e,a){if(c.offsetLabel.indexOf(i)!=-1)return l.selectedRegion=t.id,l.selectedTimezone=a,n.debug("GUESSED TIMEZONE"),o=!0,!1}),o)return!1}),o},getZones:function(t){e.each(n.tz,function(n,i){if(i.id==l.selectedRegion)return e.each(i.timezones,function(n,l){e.each(l.labels,function(e,n){return t(n,l.offsetLabel),!1})}),!1})}};return l.elem=this,this.addClass("tzwidget"),l.init(),n.onInit(l),l.draw(),this},e.fn.timezoneWidget.defaults={data:null,regionField:"tz_region",tzField:"timezone",defaultRegion:1024,guessUserTimezone:!1,onInit:e.noop,onRegionSelect:e.noop,onTimezoneSelect:e.noop,langSelectTZ:"Select a timezone...",toggleElem:null,translateClass:null,cookieName:"jqtzw-selectedtimezone",storeCookie:!1,loadCookie:!1,debug:e.noop}}(jQuery);
